<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
       http://www.liquibase.org/xml/ns/dbchangelog
       https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.23.xsd
       http://www.liquibase.org/xml/ns/dbchangelog-ext
       https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

  <!-- TrackRange 複合唯一鍵：seller_id + period + prefix -->
  <changeSet id="20251106-01-track-range-uk" author="turnbridge">
    <sql><![CDATA[
      ALTER TABLE track_range
        ADD CONSTRAINT uk_track_range_seller_period_prefix
        UNIQUE (seller_id, period, prefix);
    ]]></sql>
    <rollback>
      <sql><![CDATA[
        ALTER TABLE track_range
          DROP CONSTRAINT IF EXISTS uk_track_range_seller_period_prefix;
      ]]></sql>
    </rollback>
  </changeSet>

  <!-- TrackRange 起迄檢核：start_no <= end_no -->
  <changeSet id="20251106-02-track-range-check" author="turnbridge">
    <sql><![CDATA[
      ALTER TABLE track_range
        ADD CONSTRAINT ck_track_range_start_le_end
        CHECK (start_no <= end_no);
    ]]></sql>
    <rollback>
      <sql><![CDATA[
        ALTER TABLE track_range
          DROP CONSTRAINT IF EXISTS ck_track_range_start_le_end;
      ]]></sql>
    </rollback>
  </changeSet>

  <!-- UploadJobItem：job_id + line_no 索引（明細定位） -->
  <changeSet id="20251106-03-ujitem-job-line-idx" author="turnbridge">
    <sql><![CDATA[
      CREATE INDEX IF NOT EXISTS idx_ujitem_job_line
        ON upload_job_item (job_id, line_no);
    ]]></sql>
    <rollback>
      <sql><![CDATA[
        DROP INDEX IF EXISTS idx_ujitem_job_line;
      ]]></sql>
    </rollback>
  </changeSet>

  <!-- UploadJob：seller_id + created_date 索引（營運常用查詢） -->
  <changeSet id="20251106-04-uj-seller-created-idx" author="turnbridge">
    <sql><![CDATA[
      CREATE INDEX IF NOT EXISTS idx_uj_seller_created
        ON upload_job (seller_id, created_date);
    ]]></sql>
    <rollback>
      <sql><![CDATA[
        DROP INDEX IF EXISTS idx_uj_seller_created;
      ]]></sql>
    </rollback>
  </changeSet>

  <!-- UploadJobItem：status + result_code 索引（錯誤篩查/分頁） -->
  <changeSet id="20251106-05-ujitem-status-rc-idx" author="turnbridge">
    <sql><![CDATA[
      CREATE INDEX IF NOT EXISTS idx_ujitem_status_rc
        ON upload_job_item (status, result_code);
    ]]></sql>
    <rollback>
      <sql><![CDATA[
        DROP INDEX IF EXISTS idx_ujitem_status_rc;
      ]]></sql>
    </rollback>
  </changeSet>

  <!-- StoredObject：sha256 索引（內容去重/重用） -->
  <changeSet id="20251106-06-so-sha256-idx" author="turnbridge">
    <sql><![CDATA[
      CREATE INDEX IF NOT EXISTS idx_so_sha256
        ON stored_object (sha_256);
    ]]></sql>
    <rollback>
      <sql><![CDATA[
        DROP INDEX IF EXISTS idx_so_sha256;
      ]]></sql>
    </rollback>
  </changeSet>

  <!-- 小優化（可選）：TrackRange 常用查詢索引 -->
  <changeSet id="20251106-07-tr-seller-period-idx" author="turnbridge" context="!test">
    <sql><![CDATA[
      CREATE INDEX IF NOT EXISTS idx_tr_seller_period
        ON track_range (seller_id, period);
    ]]></sql>
    <rollback>
      <sql><![CDATA[
        DROP INDEX IF EXISTS idx_tr_seller_period;
      ]]></sql>
    </rollback>
  </changeSet>

  <changeSet id="20251106-08-tr-status-idx" author="turnbridge" context="!test">
    <sql><![CDATA[
      CREATE INDEX IF NOT EXISTS idx_tr_status
        ON track_range (status);
    ]]></sql>
    <rollback>
      <sql><![CDATA[
        DROP INDEX IF EXISTS idx_tr_status;
      ]]></sql>
    </rollback>
  </changeSet>

</databaseChangeLog>
