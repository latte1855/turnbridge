# API-first development with OpenAPI
# 這份檔案會由 openapi-generator 於編譯時產生 Spring MVC 的 endpoint stubs（Resource/Delegate）
openapi: '3.0.1'
info:
  title: 'turnbridgeBackend'  # 與 JHipster 專案一致即可
  version: 1.0.0
  description: |
    TurnBridge（橋票雲）Inbound/Outbound API
    - 支援 CSV/ZIP 上傳（多 Profile 自動判斷或手動指定）
    - 批次狀態/明細查詢、回饋 CSV 下載
    - 後端會將資料轉 Canonical，產生 MIG 4.1 XML 並投遞至 Turnkey 目錄
servers:
  # 注意：JHipster 預設 server url 已含 /api 前綴，paths 就不要再加 /api
  - url: http://localhost:8080/api
    description: Development server
  - url: https://localhost:8080/api
    description: Development server with TLS Profile

tags:
  - name: Upload
    description: 上傳與批次建立
  - name: Jobs
    description: 批次與明細查詢
  - name: Results
    description: 回饋生成與下載

paths:
  # ========= 上傳入口 =========
  /invoices/upload:
    post:
      operationId: uploadInvoices
      tags: [Upload]
      summary: 上傳發票 CSV 或 ZIP
      description: |
        用途：
        - 接收 CSV/ZIP，建立 UploadJob 與 JobItem（非同步處理）
        - 若未指定 profile，系統會依抬頭欄位自動判斷（Legacy / Canonical）
        - 建議檔名：INV_UPLOAD_{sellerId}_{yyyyMMddHHmmss}.csv|zip
        容量：
        - >50MB 請改分批或透過 SFTP（由 Agent 監看）
      security:
        - jwt: []   # 沿用 JHipster 的 jwt security scheme
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file, sellerId]
              properties:
                file:
                  type: string
                  format: binary
                  description: 上傳檔案（CSV 或 ZIP，UTF-8）
                sellerId:
                  type: string
                  description: 賣方統編或客戶識別碼
                  example: "24567891"
                profile:
                  type: string
                  description: 選填；若省略則由系統自動偵測
                  enum: [Profile-Legacy, Profile-Canonical]
                  example: "Profile-Legacy"
      responses:
        '202':
          description: 已接收並建立批次（非同步）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadAck'
              examples:
                accepted:
                  summary: 建立成功的回覆
                  value:
                    jobId: "JOB-20251105-0001"
                    receivedAt: "2025-11-05T04:12:33Z"
                    profile: "Profile-Legacy"
                    itemsCount: 1200
        '400':
          $ref: '#/components/responses/Problem'
        '401':
          $ref: '#/components/responses/Problem'
        '413':
          description: 檔案過大（請使用分批或 SFTP）

  # ========= 批次狀態 =========
  /upload-jobs/{jobId}:
    get:
      operationId: getUploadJob
      tags: [Jobs]
      summary: 查詢上傳批次狀態
      description: 回傳 UploadJob 當前狀態與統計
      security:
        - jwt: []
      parameters:
        - name: jobId
          in: path
          required: true
          description: 批次識別碼（由上傳時回傳）
          schema:
            type: string
          example: "JOB-20251105-0001"
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadJob'
              examples:
                processing:
                  summary: 處理中批次
                  value:
                    jobId: "JOB-20251105-0001"
                    sellerId: "24567891"
                    profile: "Profile-Legacy"
                    status: "VALIDATING"
                    createdAt: "2025-11-05T04:12:33Z"
                    updatedAt: "2025-11-05T04:16:01Z"
                    counters:
                      total: 1200
                      accepted: 1180
                      failed: 20
                      sent: 0
        '401':
          $ref: '#/components/responses/Problem'
        '404':
          $ref: '#/components/responses/Problem'

  # ========= 批次明細 =========
  /upload-jobs/{jobId}/items:
    get:
      operationId: listUploadJobItems
      tags: [Jobs]
      summary: 查詢批次明細與每筆處理結果
      description: |
        可分頁與過濾（status/resultCode），供 Portal 顯示逐筆錯誤訊息引導修正。
      security:
        - jwt: []
      parameters:
        - name: jobId
          in: path
          required: true
          description: 批次識別碼
          schema:
            type: string
          example: "JOB-20251105-0001"
        - name: page
          in: query
          description: 第幾頁（0-based）
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: size
          in: query
          description: 每頁筆數
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 100
        - name: status
          in: query
          description: 以處理狀態過濾
          schema:
            type: string
            enum: [QUEUED, OK, ERROR]
          example: "ERROR"
        - name: resultCode
          in: query
          description: 以錯誤碼過濾（例如 0402、0510）
          schema:
            type: string
          example: "0510"
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PageJobItemResult'
              examples:
                pageError:
                  summary: 錯誤篩選結果（第 1 頁，每頁 2 筆）
                  value:
                    content:
                      - lineNo: 12
                        traceId: "TRC-20251105-0001-000012"
                        invoiceNo: null
                        buyerId: "12233456"
                        amount: 1580
                        status: "ERROR"
                        resultCode: "0510"
                        resultMsg: "含稅/未稅金額不平"
                      - lineNo: 48
                        traceId: "TRC-20251105-0001-000048"
                        invoiceNo: null
                        buyerId: "53456789"
                        amount: 899
                        status: "ERROR"
                        resultCode: "0402"
                        resultMsg: "必要欄位缺漏：buyerName"
                    page: 1
                    size: 2
                    totalElements: 20
                    totalPages: 10
        '401':
          $ref: '#/components/responses/Problem'
        '404':
          $ref: '#/components/responses/Problem'

  # ========= 回饋 CSV 下載 =========
  /upload-jobs/{jobId}/result:
    get:
      operationId: downloadUploadJobResult
      tags: [Results]
      summary: 下載回饋 CSV（原欄位 + result_* 欄位）
      description: |
        下載內容：
        - 以原上傳 CSV 的欄位為基礎，尾欄加上：
          result_code, result_msg, trace_id, assigned_invoice_no
        - 預設輸出 UTF-8 with BOM（Excel 友善）
      security:
        - jwt: []
      parameters:
        - name: jobId
          in: path
          required: true
          description: 批次識別碼
          schema:
            type: string
          example: "JOB-20251105-0001"
        - name: bom
          in: query
          description: 是否加入 UTF-8 BOM（預設 true）
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: CSV 檔案內容
          content:
            text/csv:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              description: 下載檔名
              schema:
                type: string
              example: attachment; filename="JOB-20251105-0001-result.csv"
        '401':
          $ref: '#/components/responses/Problem'
        '404':
          $ref: '#/components/responses/Problem'

components:
  # ====== 保留 JHipster 預設的 Problem 響應（整個 Response 供 $ref 使用） ======
  responses:
    Problem:
      description: error occurred - see status code and problem object for more information.
      content:
        application/problem+json:
          schema:
            type: object
            properties:
              type:
                type: string
                format: uri
                description: |
                  An absolute URI that identifies the problem type.  When dereferenced,
                  it SHOULD provide human-readable documentation for the problem type.
                default: 'about:blank'
                example: 'https://www.jhipster.tech/problem/problem-with-message'
              title:
                type: string
                description: A short, summary of the problem type (English).
                example: 'Bad Request'
              status:
                type: integer
                format: int32
                description: The HTTP status code.
                minimum: 100
                maximum: 600
                exclusiveMaximum: true
                example: 400
              detail:
                type: string
                description: A human readable explanation specific to this occurrence of the problem.
                example: 'CSV 欄位 buyerName 缺漏'
              instance:
                type: string
                format: uri
                description: An absolute URI that identifies the specific occurrence of the problem.

  # ====== 與 JHipster 相容的 SecuritySchemes（jwt/basic） ======
  securitySchemes:
    jwt:
      type: http
      description: JWT Authentication
      scheme: bearer
      bearerFormat: JWT
    basic:
      type: http
      description: Basic Authentication
      scheme: basic

  # ====== 本專案的 DTO Schemas（繁中註解 + 範例） ======
  schemas:
    # 上傳接收回覆
    UploadAck:
      type: object
      description: 上傳成功建立批次後的回覆（非同步處理）
      properties:
        jobId:
          type: string
          description: 批次識別碼
          example: "JOB-20251105-0001"
        receivedAt:
          type: string
          format: date-time
          description: 伺服器接收時間（UTC ISO-8601）
          example: "2025-11-05T04:12:33Z"
        profile:
          type: string
          description: 使用的 Profile 名稱（若為自動偵測，回傳判定結果）
          example: "Profile-Legacy"
        itemsCount:
          type: integer
          description: 解析得到的列數（ZIP 需解開後才精準）
          example: 1200

    # 批次主檔
    UploadJob:
      type: object
      description: 上傳批次主檔狀態與統計
      properties:
        jobId:
          type: string
          example: "JOB-20251105-0001"
        sellerId:
          type: string
          example: "24567891"
        profile:
          type: string
          example: "Profile-Legacy"
        status:
          type: string
          description: 批次處理狀態
          enum: [RECEIVED, PARSING, VALIDATING, PACKING, SENT, RESULT_READY, FAILED]
          example: "VALIDATING"
        createdAt:
          type: string
          format: date-time
          example: "2025-11-05T04:12:33Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-11-05T04:16:01Z"
        counters:
          type: object
          description: 批次統計數量
          properties:
            total:
              type: integer
              example: 1200
            accepted:
              type: integer
              example: 1180
            failed:
              type: integer
              example: 20
            sent:
              type: integer
              example: 0

    # 批次明細結果
    JobItemResult:
      type: object
      description: 批次中每筆資料的處理結果（含錯誤碼與訊息）
      properties:
        lineNo:
          type: integer
          description: 原始檔行號（從 1 起算）
          example: 12
        traceId:
          type: string
          description: 該筆資料的全流程追蹤 ID
          example: "TRC-20251105-0001-000012"
        invoiceNo:
          type: string
          nullable: true
          description: 系統分配或上傳指定的發票號碼（若尚未分配可為 null）
          example: "AB12345678"
        buyerId:
          type: string
          example: "12233456"
        amount:
          type: number
          format: double
          example: 1580
        status:
          type: string
          enum: [QUEUED, OK, ERROR]
          example: "ERROR"
        resultCode:
          type: string
          description: 錯誤碼（如 0402 欄位缺漏、0510 金額不平…）
          example: "0510"
        resultMsg:
          type: string
          description: 錯誤訊息（可讀）
          example: "含稅/未稅金額不平"

    # 分頁包裝
    PageJobItemResult:
      type: object
      description: 分頁查詢結果
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/JobItemResult'
        page:
          type: integer
          example: 1
        size:
          type: integer
          example: 2
        totalElements:
          type: integer
          example: 20
        totalPages:
          type: integer
          example: 10

# 全域 Security（可由 Filter/Config 覆蓋）
security:
  - jwt: []
  - basic: []
