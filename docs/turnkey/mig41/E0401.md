# ✅ **E0401 — 總、分支機構配號檔（BranchTrack）**

---

# 📌 1. 訊息用途

來源：

> **「總、分支機構配號檔」係營業人總機構及分支機構之電子發票字軌配號上傳檔。**
> 總機構需上傳其所有分支機構的起迄字軌，若發生重複字軌區間會被平台完全覆蓋（以後送為準）。

---

# 📌 2. 樹狀圖（依 MIG 規格）

來源：

```
BranchTrack
 ├── Main
 │     ├── HeadBan
 │     ├── BranchBan
 │     ├── YearMonth
 │     ├── InvoiceTrack
 │     ├── InvoiceBeginNo
 │     ├── InvoiceEndNo
 │     └── InvoiceType
 │
 └── Details
        └── BranchTrackItem (1..25000)
              ├── InvoiceBeginNo
              ├── InvoiceEndNo
              └── InvoiceBooklet
```

---

# 📌 3. 完整欄位表（Main）

來源：

* Main 區塊：
* 詳細欄位表：

| 欄位                 | 必要性 | 型別                   | 備註             |
| ------------------ | --- | -------------------- | -------------- |
| **HeadBan**        | M   | BAN                  | 總公司統一編號        |
| **BranchBan**      | M   | BAN                  | 分支機構統一編號       |
| **YearMonth**      | M   | YearMonth (6 digits) | 配號期間（例：202401） |
| **InvoiceTrack**   | M   | string(2)            | 字軌（例：AB）       |
| **InvoiceBeginNo** | M   | string(8)            | 配號起始號碼         |
| **InvoiceEndNo**   | M   | string(8)            | 配號結束號碼         |
| **InvoiceType**    | M   | InvoiceTypeEnum      | 07 或 08        |

補充：
InvoiceTypeEnum 在 MIG 標示限制：
來源：

> pattern="[07,08]"

---

# 📌 4. 完整欄位表（Details → BranchTrackItem）

來源：

| 欄位                 | 必要性 | 型別              | 備註    |
| ------------------ | --- | --------------- | ----- |
| **InvoiceBeginNo** | M   | string(8)       | 明細起始號 |
| **InvoiceEndNo**   | M   | string(8)       | 明細結束號 |
| **InvoiceBooklet** | M   | long(10 digits) | 本組數   |

來源補強（InvoiceBooklet）：

---

# 📌 5. 訊息結構摘要

E0401 相當簡單，僅二層：

* **Main** → 匯總該分支的所有配號資訊
* **Details** → 1~25000 組明細，每組為「起迄號 + 本數」

平台會比對先後順序：

> 若重新上傳同一 BranchTrack/Main（同 HeadBan + BranchBan + YearMonth + InvoiceTrack）
> 則 **前次資料會全部被覆蓋**。

來源：

---

# 📌 6. 典型 XML 範例（來自 MIG 教材）

來源：

```
<BranchTrack>
    <Main>
        <HeadBan>12345678</HeadBan>
        <BranchBan>87654321</BranchBan>
        <InvoiceType>07</InvoiceType>
        <YearMonth>10606</YearMonth>
        <InvoiceTrack>AB</InvoiceTrack>
        <InvoiceBeginNo>00001000</InvoiceBeginNo>
        <InvoiceEndNo>00001999</InvoiceEndNo>
    </Main>
    <Details>
        <BranchTrackItem>
            <InvoiceBeginNo>00001000</InvoiceBeginNo>
            <InvoiceEndNo>00001499</InvoiceEndNo>
            <InvoiceBooklet>10</InvoiceBooklet>
        </BranchTrackItem>
    </Details>
</BranchTrack>
```

---
