# TurnBridge（橋票雲）系統規格書 v1.0

> **更新日期**：2025-11-05（Asia/Taipei）
> **適用版本**：MIG 4.1
> **Turnkey 版本**：3.9（財政部電子發票 Java 工具）
> **系統框架**：JHipster v8.11.0（Spring Boot 3.4.x / React 19）
> **專案代號**：`turnbridge-backend`

---

## 0. 系統目標與範圍

TurnBridge（橋票雲）是一套電子發票加值平台，提供企業發票資料轉換與財政部 Turnkey 串接功能。

**主要任務如下：**

1. 接收各企業上傳之發票資料（CSV、ZIP 或 REST JSON）。
2. 進行格式驗證、稅額檢核與 Canonical 結構轉換。
3. 依 MIG 4.1 規格生成發票 XML，置入 Turnkey 傳送目錄。
4. 由 Turnkey 系統上傳至財政部電子發票平台。
5. 接收財政部回饋檔，解析後回傳處理結果給業者。
6. 提供 Portal 查詢、對帳、重送與報表功能。

> 本系統以「加值商」身份運作。客戶端不需設定憑證，與加值平台間資料傳輸可使用 AES 加密通道。

---

## 1. 系統架構概述

### 1.1 系統組成

| 層級   | 模組                     | 技術架構                                                         | 功能說明                 |
| ---- | ---------------------- | ------------------------------------------------------------ | -------------------- |
| 應用層  | **TurnBridge Backend** | Spring Boot (JHipster Monolith) + PostgreSQL + Redis + MinIO | 主系統：資料接收、轉換、投遞、回饋處理  |
| 前端層  | **TurnBridge Portal**  | React 19 + Tailwind + shadcn/ui                              | 客戶入口：上傳紀錄、錯誤重送、回饋下載  |
| 客戶端  | **TurnBridge Agent**   | JavaFX / Spring Boot / Node CLI                              | 安裝於客戶端，提供檔案監控與加密上傳功能 |
| 外部系統 | **財政部 Turnkey**        | Java 套件（SendFile / ReceiveFile）                              | 發票上傳與回饋管道            |

### 1.2 資料流程

```
客戶端 CSV/ZIP
↓
Inbound → 驗證 → Canonical 標準化
↓
MIG4.1 XML 產生
↓
Turnkey SendFile/*/SRC
↓
財政部 Turnkey 上傳
↓
回饋檔 ReceiveFile/*/SRC
↓
回饋解析與結果回傳（CSV 或 REST）
```

### 1.3 儲存與整合

* **PostgreSQL**：業務資料與 Canonical 結構（線上一年資料）
* **Redis**：快取、分散鎖（配號與批次併發控制）
* **MinIO / S3**：原始 CSV、MIG XML、回饋檔長期保存（六年）
* **分區策略**：以「期別（2 個月）」為分區鍵。

---

## 2. 資料量與規模預估

| 項目       | 預估值                                 | 說明             |
| -------- | ----------------------------------- | -------------- |
| 客戶數      | 約 500 家                             | 平均每期（2 個月）均有上傳 |
| 每期發票數    | 每客戶最少 6,000 張 × 500 客戶 = **300 萬張** | 含 B2B 與 B2C    |
| 每筆發票平均明細 | 約 3 筆                               | 約 900 萬筆明細記錄   |
| 每日批次量    | 約 10～50 萬筆（上傳 + 回饋）                 | 含多次重送          |
| 每期字軌數    | 約 1,000 段（2 個月）                     | 需精確控號避免重號      |
| 歷史保存量    | 6 年 × 每期 300 萬張 ≈ 1.08 億筆           | 歷史歸檔需高壓縮與索引化   |

**系統設計策略：**

* 資料庫分區：以期別（YYYYMM）為分區鍵。
* 動態配號：`TrackRange + currentNo` 控制，避免預展開。
* 批次 Job 架構：UploadJob / JobItem 管控，對應 ProcessResult。
* 查詢分層：線上一年資料 + 歷史快取索引。
* 高併發控制：Redis + DB 鎖。
* 儲存壓縮策略：歷史 XML/CSV 壓縮歸檔，metadata 存索引表。

---

## 3. 系統策略總覽

| 面向     | 採用策略                                  | 補充說明        |
| ------ | ------------------------------------- | ----------- |
| 號碼分配   | `TrackRange + currentNo` 動態分配（不預展開）   | 保證唯一性、避免表膨脹 |
| 發票資料保留 | 線上 1 年 + 冷儲 6 年                       | 以索引表快速查歷史   |
| 客戶資料交換 | CSV 為主，上傳與回饋成對                        | 兼容現有流程      |
| 批次處理架構 | Job / JobItem 對應 ProcessResult        | 冪等且可追蹤      |
| 安全機制   | AES-256-GCM + HTTPS/SFTP；Turnkey 憑證獨立 | 雙層防護        |
| 擴展性    | 分區 + 模組化 MIG 支援                       | 可平行共存不同版本   |
| 資料量    | 每期約 300 萬張發票                          | 系統需支援高併發處理  |

---

## 4. 特殊考量與風險項目

| 類別             | 說明                                         |
| -------------- | ------------------------------------------ |
| 重送與錯誤機制        | ProcessResult 含多種錯誤（欄位、簽章、重號），需可修正重送與作廢重開。 |
| 批次監控 Dashboard | 監控每日上傳成功率、失敗率、延遲時間，支援分客戶統計與趨勢圖。            |
| 併發控制           | 每個字軌僅允許單一實例發號，使用 Redis 或 DB 鎖。             |
| 稅額驗證           | 自動依稅別（TX/免稅/零稅）與 B2B/B2C 類型區分邏輯。           |
| 字軌到期           | 自動產生空白發票回報（E0402）。                         |
| 保存策略           | 歷史資料採壓縮歸檔 + metadata 索引。                   |
| 稽核             | 全流程 TraceId 追蹤與 SHA-256 指紋校驗。              |
| MIG 版本支援       | 可平行支援 MIG 4.1、4.2 等版本。                     |

---

## 5. 功能需求（Functional Requirements）

### FR-1 上傳與批次管理

1. 上傳方式：

   * REST API：`POST /api/invoices/upload`
   * SFTP：`/inbound/seller/{sellerId}/upload/`
2. 支援多種 CSV Profile（Legacy / Canonical）。
3. 建立批次記錄 `UploadJob` 與明細 `JobItem`。
4. 同號合併、多明細處理。
5. 無號時自動呼叫 **NumberingAgent** 配號。

### FR-2 驗證與標準化

1. 驗證欄位型別與格式。
2. 稅別與金額平衡檢查。
3. 轉換至 Canonical 結構。
4. 錯誤記錄於 JobItem.resultCode / resultMsg。

### FR-3 MIG4.1 XML 產生與封裝

1. 支援 C0401、C0501、C0701 訊息別。
2. 批次打包：每 1000 筆或 15MB（擇一）。
3. 產出目錄：

   * `SendFile/B2SSTORAGE/SRC`
   * `SendFile/B2BEXCHANGE/SRC`

### FR-4 財政部回饋解析

1. 解析 ProcessResult.xml、SummaryResult.xml、E05xx 錯誤。
2. 更新 Job/Item 狀態。
3. 產出回饋 CSV（附 result_code / trace_id 等）。
4. Portal 提供下載與查詢。

### FR-5 字軌配號與控制

1. 讀取 E0401 建立 `TrackRange`。
2. 動態配號（非預展式）。
3. 期末產生 E0402 空白回報。
4. DB 樂觀鎖 + Redis 鎖控。

### FR-6 對帳與報表

1. 比對 SummaryResult 與內部統計。
2. 報表化呈現差異與警示。

### FR-7 資料查詢與保留

1. 線上資料：PostgreSQL（1 年）。
2. 歷史資料：MinIO（6 年）。
3. Portal 提供查詢、重送、回饋下載。

---

## 6. 非功能需求（Non-Functional Requirements）

| 類別  | 項目                   | 指標 / 備註              |
| --- | -------------------- | -------------------- |
| 可靠性 | Job 冪等重試             | 重送不重複入帳              |
| 效能  | 高併發處理                | 日處理 10～50 萬筆         |
| 安全性 | 雙層加密                 | AES-256-GCM + HTTPS  |
| 擴展性 | 分區 + 索引查詢            | 跨期查詢加速               |
| 權限  | JWT + RBAC           | Portal / Admin / Ops |
| 監控性 | Prometheus + Grafana | 成功率與延遲監控             |
| 維護性 | Profile YAML         | 客戶格式可設定化             |

---

## 7. 資料模型與關聯

### 7.1 主要實體

| 實體                                    | 功能      |
| ------------------------------------- | ------- |
| UploadJob                             | 批次上傳主檔  |
| JobItem                               | 批次明細    |
| CanonicalInvoice                      | 標準化發票主檔 |
| InvoiceItem                           | 明細項目    |
| Tax                                   | 稅額資料    |
| TrackRange                            | 字軌配號區間  |
| ProcessResultFile / SummaryResultFile | 回饋檔記錄   |

### 7.2 關聯關係

```
UploadJob 1 ── * JobItem
JobItem 1 ── 1 CanonicalInvoice
CanonicalInvoice 1 ── * InvoiceItem
TrackRange 1 ── * CanonicalInvoice
```

### 7.3 基本欄位

* 通用欄位：`id`, `createdBy`, `createdDate`, `lastModifiedBy`, `lastModifiedDate`, `deleted`
* 樂觀鎖：`@Version`（TrackRange, Invoice）
* 軟刪除：`@Where(clause="deleted=false")`

---

## 8. 系統安全設計

1. **身份驗證**：JWT（Access Token + Refresh Token）
2. **角色權限**：

   * `ROLE_PORTAL_USER`：客戶端資料權限
   * `ROLE_ADMIN`：營運管理
   * `ROLE_OPS`：系統維運
3. **傳輸安全**：

   * REST：HTTPS + JWT
   * SFTP：密鑰驗證
   * 檔案內容：AES-256-GCM 加密
4. **稽核與審計**：

   * 每筆資料具 TraceId
   * 封包 SHA-256 指紋
   * 關鍵事件皆紀錄於審計表。

---

## 9. 保留年限與備份策略

| 類別                         | 保留方式             | 保存年限 |
| -------------------------- | ---------------- | ---- |
| 主資料庫（PostgreSQL）           | 線上查詢             | 1 年  |
| 歷史資料（MinIO / S3）           | 壓縮歸檔（CSV/XML/回饋） | 6 年  |
| 系統設定（TrackRange / Profile） | 永久保留（版本化）        | 長期   |

---

## 10. 風險與對策

| 風險項目         | 對策                      |
| ------------ | ----------------------- |
| 發票號碼重複       | 動態取號 + DB 鎖控；Job 狀態回滾   |
| Turnkey 傳輸失敗 | 監控目錄 + 重送佇列             |
| 大量上傳壓力       | Job Queue + 分批打包        |
| 回饋解析錯誤       | 自動隔離 + 重試機制             |
| 客戶格式變動       | YAML Profile 設定化，不影響主程式 |

---

## 11. 後續擴展與演進預案

1. **MIG 多版本共存**

   * 各版本邏輯封裝於 `/modules/mig/{version}/`
   * Spring Conditional Bean / SPI 裝載
   * Canonical 層與 MIG 層完全解耦

2. **分散式處理預留**

   * 可拆為 Upload、Pack、Result 微服務
   * 使用 Kafka 或 Redis Stream 傳遞事件

3. **高可用性**

   * PostgreSQL Streaming Replication
   * Redis Sentinel Cluster
   * MinIO Erasure Code 多節點

4. **報表與 BI 擴展**

   * 每日自動產出成功率、錯誤統計報表
   * 可推送至 Data Warehouse

---

## 12. 文件關聯與維護

| 類別             | 檔案                                             | 用途          |
| -------------- | ---------------------------------------------- | ----------- |
| 系統架構           | `/docs/turnkey/architecture-csv-to-turnkey.md` | 整體流程圖       |
| CSV Profile    | `/docs/turnkey/csv-profiles-spec.md`           | CSV 欄位規格    |
| Header Mapping | `/docs/turnkey/header-mapping-sample.yaml`     | 欄位對映設定      |
| OpenAPI        | `/docs/turnkey/turnkey-inbound-outbound.yaml`  | REST API 定義 |
| 任務清單           | `/docs/turnkey/todo-tasks.md`                  | 開發進度追蹤      |
| 任務代理           | `/AGENTS.md`                                   | 模組分工與職責     |

---

## 13. 里程碑（Milestones）

| 階段 | 範圍 | 主要內容 | 交付條件（DoD） | 目標時間 |
| ---- | ---- | -------- | --------------- | -------- |
| M0 | 規格與環境 | 規格書、CSV Profiles、Header Mapping、OpenAPI、Monorepo 設定 | 文件齊備、api.yml 可產生 stub、repo 結構正確 | 2025-11 |
| M1 | Happy Path | 上傳→轉換→MIG4.1 出包→回饋解析→回饋 CSV | 端到端流程可跑、XSD 驗證通過、主要 API 與占位頁可用 | 2026-Q1 |
| M2 | 字軌與對帳 | E0401/E0402、錯誤分流（重送/重開）、對帳報表、Dashboard | 可操作重送/重開、日/期統計與差異報表完整 | 2026-Q2 |
| M3 | Agent/監控 | Agent（SFTP/Watcher）、WebSocket 即時通知、Prom/Grafana | Agent 佈署、即時通知、核心指標/告警線上化 | 2026-Q3 |

---

## 14. 版本與修訂紀錄

| 版本   | 日期         | 修訂說明                 |
| ---- | ---------- | -------------------- |
| v1.0 | 2025-11-05 | 初版，含資料量預估、風險策略與擴展設計。 |
| v1.1 | （預留）       | 新增監控、告警與 Agent 模組。   |

---

**文件完**
