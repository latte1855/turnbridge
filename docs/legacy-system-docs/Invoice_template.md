# Invoice 發票資料 CSV 匯入範本

## 📋 欄位對應（以 Invoice Entity 欄位為基準）

| Index | Entity 欄位名 | 中文說明 | 型態 | 必填 | 長度 | 範例 |
|-------|--------------|--------|------|------|------|------|
| 0 | messageType | 訊息類別 | string | Y | - | C0401/A0401/C0501/C0701 |
| 1 | invoiceNumber | 發票號碼 | string | Y | 10 | AB12345678 |
| 2 | invoiceDate | 發票日期 | string | Y | 8 | 20251101 |
| 3 | invoiceTime | 發票時間 | string | Y | 8 | 12:00:01 |
| 4 | sellerIdentifier | 賣方統一編號 | string | Y | 10 | 12345678 |
| 5 | sellerName | 賣方名稱 | string | Y | 60 | 匯泓企業社 |
| 6 | buyerIdentifier | 買方統一編號 | string | Y | 10 | 0000000000/12345678 |
| 7 | buyerName | 買方名稱 | string | Y | 60 | 0000/買方公司名 |
| 8 | invoiceType | 發票類別 | string | Y | - | 07/08 |
| 9 | donateMark | 捐贈註記 | string | Y | 1 | 0(否)/1(是) |
| 10 | carrierType | 載具類別號碼 | string | N | 6 | 3J0002/CQ0001 |
| 11 | carrierId1 | 載具顯碼ID | string | N | 64 | /ABC1234 |
| 12 | carrierId2 | 載具隱碼ID | string | N | 64 | /ABC1234 |
| 13 | printMark | 已列印註記 | string | Y | 1 | Y(是)/N(否) |
| 14 | npoban | 捐贈對象 | string | N | 10 | 公益團體代號(3-7碼) |
| 15 | randomNumber | 防偽隨機碼 | string | Y | 4 | 1A2B(4碼:0-9,A) |
| 16 | description(明細) | 品名 | string | Y | 256 | 品名A |
| 17 | quantity(明細) | 數量 | decimal | Y | - | 2/2.5 |
| 18 | unitPrice(明細) | 單價 | decimal | Y | - | 100/100.00 |
| 19 | amount(明細) | 金額 | decimal | Y | - | 200/250.50 |
| 20 | sequenceNumber(明細) | 明細序號 | string | Y | 3 | 1/2/3 |
| 21 | salesAmount | 應稅銷售額 | decimal | Y | - | 200 |
| 22 | freeTaxSalesAmount | 免稅銷售額 | decimal | Y | - | 0 |
| 23 | zeroTaxSalesAmount | 零稅率銷售額 | decimal | Y | - | 0 |
| 24 | taxType | 課稅別 | string | Y | 1 | 1(應稅)/2(零稅) |
| 25 | taxRate | 稅率 | decimal | Y | - | 0.05(5%) |
| 26 | taxAmount | 營業稅額 | decimal | Y | - | 10 |
| 27 | totalAmount | 總計 | decimal | Y | - | 210 |
| 28 | discountAmount | 折扣金額 | decimal | N | - | 0 |
| 29 | cardLast4No | 信用卡末四碼 | string | N | 4 | 1234 |

---

## 📝 範例資料

### 範例一：C0401 - 開立發票（單一明細）
```
C0401|AB00001002|20250101|12:00:01|12345678|匯泓企業社|98765432|購買公司|07|0|3J0002|/ABC1234|0|Y|0|1A2B|物件A|2|100|200|1|200|0|0|1|0.05|10|210|0|
```

### 範例二：A0401 - 修正(更正)發票（單一明細）
```
A0401|EA44185950|20220913|15:30:45|24053211|匯泓企業社|0000000000|購買人|07|0|3J0002|/ABC1234|0|Y|0|2C3D|商品|3|150|450|1|450|0|0|1|0.05|22.5|472.5|0|1234
```

### 範例三：C0401 - 多明細聚合（同發票多列商品）
```
# 同一張發票的多個商品須分行輸入，系統會自動聚合到同一張發票
# invoiceNumber 與 invoiceDate 相同時，系統聚合為一張發票；金額會自動加總
C0401|AB00001003|20250102|09:15:00|12345678|匯泓企業社|11111111|B公司|07|0|3J0002|/XYZ5678|0|Y|0|3E4F|商品A|1|500|500|1|1000|0|0|1|0.05|50|1050|0|
C0401|AB00001003|20250102|09:15:00|12345678|匯泓企業社|11111111|B公司|07|0|3J0002|/XYZ5678|0|Y|0|3E4F|商品B|1|500|500|2|
```

### 範例四：C0501 - 作廢發票
```
C0501|AB00001004|20250103|10:30:00|12345678|匯泓企業社|22222222|C公司|07|0|3J0002|/DEF9012|0|Y|0|4G5H|服務費|1|1000|1000|1|1000|0|0|1|0.05|50|1050|0|
```

### 範例五：C0701 - 銷項折讓(退貨)
```
# 折讓時金額欄位使用負數表示退回
C0701|AB00001005|20250104|14:45:00|12345678|匯泓企業社|33333333|D公司|07|0|3J0002|/GHI3456|0|Y|0|5I6J|退貨商品|-1|200|200|1|-200|0|0|1|0.05|-10|-210|50|
```

---

## 📂 檔案格式說明

### 編碼格式
- **必要編碼**：UTF-8（無 BOM，系統自動移除 BOM）
- **字元集**：完整 Unicode，支援繁體中文
- **不支援**：BIG5、GB2312 等其他編碼

### 分隔符號
- **分隔符**：管線符 `|`（不是逗號）
- **無引號**：欄位內容無需加引號
- **無 Header**：資料直接開始，無第一列標題

### 檔名規範
- **格式**：`invoice_[BAN]_[YYYYMMDD]_[4位記錄數].csv`
- **說明**：
  - `[BAN]`：賣方統一編號（8 碼）
  - `[YYYYMMDD]`：檔案建立日期
  - `[4位記錄數]`：檔案中包含的資料筆數（0001-9999）
- **範例**：
  - `invoice_12345678_20250113_0001.csv`（1 筆）
  - `invoice_24053211_20250113_0012.csv`（12 筆）
  - `invoice_12345678_20250113_0050.csv`（50 筆）

### 名稱末尾 4 碼驗證
- **系統檢查**：檔名中的 4 位數字必須等於實際資料列數
- **若不符**：系統拒絕匯入
- **範例**：
  - ✓ 檔名 `...0003.csv` 且檔案有 3 行資料 → 通過
  - ❌ 檔名 `...0003.csv` 但檔案有 5 行資料 → 拒絕

---

## 🎯 欄位詳細說明

### 0️⃣ MessageType - 訊息類別
- **長度**：-（列舉）
- **必填**：是
- **有效值**：
  | 代碼 | 說明 | 用途 |
  |-----|------|------|
  | C0401 | 開立發票 | 新建發票 |
  | A0401 | 修正發票 | 修改已開立發票（跨期更正） |
  | A0101 | 更正發票 | 更正已開立發票（同期更正） |
  | C0501 | 作廢發票 | 作廢已開立發票 |
  | A0501 | 修正作廢 | 修改作廢狀態 |
  | A0201 | 更正作廢 | 更正作廢發票 |
  | C0701 | 銷項折讓 | 退貨或折扣 |
  | A0601 | 修正折讓 | 修改折讓狀態 |
  | A0301 | 更正折讓 | 更正折讓發票 |
- **範例**：`C0401`

### 1️⃣ invoiceNumber - 發票號碼
- **長度**：10 碼
- **必填**：是
- **格式**：`[A-Z]{2}[0-9]{8}`
- **驗證**：
  - 第 1-2 碼：大寫英文字母
  - 第 3-10 碼：數字
  - 須符合配號檔中的起迄號範圍
- **範例**：`AB12345678`、`EA44185950`、`WB00001000`

### 2️⃣ invoiceDate - 發票日期
- **長度**：8 碼
- **必填**：是
- **格式**：`YYYYMMDD`（民國年轉西元年）
- **驗證**：
  - 範圍：20000101 以後
  - 邏輯驗證：不得超過當日日期（視系統設定）
  - 須對應 invoiceNumber 的配號期別
- **說明**：系統內部統一使用西元年
- **範例**：
  - `20250113` = 2025 年 1 月 13 日
  - `20220913` = 2022 年 9 月 13 日

### 3️⃣ invoiceTime - 發票時間
- **長度**：8 碼
- **必填**：是
- **格式**：`HH:mm:ss`（24 小時制）
- **驗證**：
  - 小時：00-23
  - 分鐘：00-59
  - 秒數：00-59
- **範例**：`12:00:01`、`09:15:30`、`00:00:00`

### 4️⃣ sellerIdentifier - 賣方統一編號
- **長度**：8-10 碼
- **必填**：是
- **格式**：8 位數字（通常）或統編
- **驗證**：
  - 須對應系統中已建檔的 Customer
  - 須匹配配號檔（E0501）中的統編
- **說明**：發票開立者/賣家
- **範例**：`12345678`、`24053211`

### 5️⃣ sellerName - 賣方名稱
- **長度**：≤ 60 字
- **必填**：是
- **字元**：支援繁體中文、英文、數字、特殊符號
- **驗證**：勿超過 60 字（計算字數含空格）
- **說明**：發票上顯示的賣方名稱
- **範例**：`匯泓企業社`、`吉米有限公司`

### 6️⃣ buyerIdentifier - 買方統一編號
- **長度**：10 碼
- **必填**：是
- **有效值**：
  - 統編形式：`12345678`（8 碼數字）
  - 無統編：`0000000000`（10 碼零）
  - 自然人：`00000000XX`（可有自然人 ID）
- **驗證**：
  - 若為統編，須符合規範
  - 若無統編，統一填 `0000000000`
- **說明**：發票購買人/買家
- **範例**：`0000000000`（個人）、`98765432`（企業）

### 7️⃣ buyerName - 買方名稱
- **長度**：≤ 60 字
- **必填**：是
- **說明**：發票上顯示的買方名稱
- **無統編規範**：若 buyerIdentifier=`0000000000`，通常填 `0000`
- **範例**：`0000`（個人購買）、`購買公司名`（企業）

### 8️⃣ invoiceType - 發票類別
- **長度**：1-2 碼
- **必填**：是
- **有效值**：
  - `07` = 一般稅額計算發票
  - `08` = 特種稅額計算發票
- **驗證**：須與配號檔中的發票類別一致
- **說明**：決定稅額計算方式
- **範例**：`07`

### 9️⃣ donateMark - 捐贈註記
- **長度**：1 碼
- **必填**：是
- **有效值**：
  - `0` = 不捐贈（一般銷售）
  - `1` = 捐贈（需搭配 npoban）
- **驗證**：
  - 若 `donateMark=1`，則 `npoban` 必填
  - `npoban` 格式：3-7 碼捐贈代號或 8 碼統編
- **說明**：是否將捐贈納入發票
- **範例**：`0`（一般）、`1`（捐贈）

### 🔟 carrierType - 載具類別號碼
- **長度**：≤ 6 碼
- **必填**：否（可空白）
- **有效值**：
  - `3J0002` = 手機條碼（統一發票掃碼載具）
  - `CQ0001` = 自然人憑證（IC 卡）
  - `會員載具` = 公司會員代號載具
  - 空白 = 無載具
- **驗證**：
  - 若填 `3J0002`，carrierId1 格式：`/XXXXXXX`
  - 若填 `CQ0001`，carrierId1 格式：`/[A-Z]{2}[0-9]{14}`
- **說明**：識別電子發票儲存媒介
- **範例**：`3J0002`、`CQ0001`、空白

### 1️⃣1️⃣ carrierId1 - 載具顯碼ID
- **長度**：≤ 64 字
- **必填**：否（取決於 carrierType）
- **格式依載具類別**：
  - 3J0002：`/XXXXXXX`（/ + 7 碼，可含 0-9、A-Z、+、-、.）
  - CQ0001：`/NNNNNNNNNNNNNNNN`（/ + 14 碼自然人 ID）
  - 會員載具：會員代號
- **驗證**：
  - 不可無故留空（若 carrierType 有填則 carrierId1 應填）
  - 格式須符合對應載具規範
- **說明**：載具的顯式識別碼
- **範例**：`/ABC1234`、`/9ABCD123456789`

### 1️⃣2️⃣ carrierId2 - 載具隱碼ID
- **長度**：≤ 64 字
- **必填**：否
- **說明**：載具的隱式識別碼（非必填，特殊情況使用）
- **範例**：`/DEF5678`、空白

### 1️⃣3️⃣ printMark - 已列印註記
- **長度**：1 碼
- **必填**：是
- **有效值**：
  - `Y` = 已列印（紙本發票）
  - `N` = 未列印（電子發票）
- **說明**：是否印製紙本發票
- **範例**：`Y`、`N`

### 1️⃣4️⃣ npoban - 捐贈對象
- **長度**：≤ 10 碼
- **必填**：條件式（當 donateMark=1 時必填）
- **有效值**：
  - 公益團體代號：3-7 碼數字
  - 統編：8 碼統編
- **驗證**：
  - 須對應財政部核准的公益組織
  - 若 donateMark=0 則此欄可空白
- **說明**：接收捐贈的公益團體代號
- **範例**：`71101`（某公益機構）、`10053088`（某基金會統編）

### 1️⃣5️⃣ randomNumber - 防偽隨機碼
- **長度**：4 碼
- **必填**：是
- **格式**：`[0-9A]{4}`（4 碼，每碼為 0-9 或 A）
- **驗證**：
  - 只能包含 0-9 和 A 字元（不可含 B-Z）
  - 不可全為 0 或全為 A（通常規範）
- **說明**：防止偽造的隨機校驗碼
- **範例**：`1A2B`、`0001`、`AAAA`

### 1️⃣6️⃣ description(明細) - 品名
- **長度**：≤ 256 字
- **必填**：是
- **說明**：商品或服務名稱
- **範例**：`物件A`、`商品 B`、`服務費`

### 1️⃣7️⃣ quantity(明細) - 數量
- **長度**：-（decimal）
- **必填**：是
- **格式**：數字，支援小數點
- **驗證**：
  - 通常為正數（除折讓時為負數）
  - 小數位數：通常 2-4 位
- **說明**：商品數量或服務單位數
- **範例**：`2`、`2.5`、`0.333`

### 1️⃣8️⃣ unitPrice(明細) - 單價
- **長度**：-（decimal）
- **必填**：是
- **格式**：數字，支援小數點
- **說明**：單位商品/服務的價格
- **範例**：`100`、`100.00`、`99.99`

### 1️⃣9️⃣ amount(明細) - 金額
- **長度**：-（decimal）
- **必填**：是
- **計算**：`amount = quantity × unitPrice`
- **驗證**：
  - 須與計算值相符（可允許小數舍入）
  - 折讓時為負數
- **範例**：`200`（= 2 × 100）、`-200`（折讓）

### 2️⃣0️⃣ sequenceNumber(明細) - 明細序號
- **長度**：≤ 3 碼
- **必填**：是
- **格式**：數字（通常 1, 2, 3...）
- **說明**：同發票內多明細的序列編號
- **範例**：`1`、`2`、`3`

### 2️⃣1️⃣ salesAmount - 應稅銷售額
- **長度**：-（decimal）
- **必填**：是
- **說明**：需課營業稅的銷售總額
- **驗證**：
  - 若無應稅銷售，填 `0`
  - 須對應明細 amount 加總
- **範例**：`200`、`0`

### 2️⃣2️⃣ freeTaxSalesAmount - 免稅銷售額
- **長度**：-（decimal）
- **必填**：是
- **說明**：不課營業稅的銷售總額（如農產品等）
- **驗證**：
  - 若無免稅銷售，填 `0`
- **範例**：`0`

### 2️⃣3️⃣ zeroTaxSalesAmount - 零稅率銷售額
- **長度**：-（decimal）
- **必填**：是
- **說明**：出口或特定商品的零稅率銷售額
- **驗證**：
  - 若無零稅率銷售，填 `0`
- **範例**：`0`

### 2️⃣4️⃣ taxType - 課稅別
- **長度**：1 碼
- **必填**：是
- **有效值**：
  - `1` = 應稅（一般銷售，課 5% 營業稅）
  - `2` = 零稅率（出口或特定商品，稅率 0%）
- **說明**：決定稅率適用
- **範例**：`1`、`2`

### 2️⃣5️⃣ taxRate - 稅率
- **長度**：-（decimal）
- **必填**：是
- **格式**：小數格式（如 0.05 = 5%）
- **有效值**：
  - `0.05` = 5%（標準稅率）
  - `0.03` = 3%（低稅率）
  - `0.00` = 0%（零稅率）
  - 特殊行業可能有其他稅率
- **驗證**：`taxAmount ≈ salesAmount × taxRate`
- **範例**：`0.05`（5%）、`0.03`（3%）、`0.00`（零稅）

### 2️⃣6️⃣ taxAmount - 營業稅額
- **長度**：-（decimal）
- **必填**：是
- **計算**：`taxAmount = salesAmount × taxRate`
- **驗證**：
  - 須與計算值相符
  - 四捨五入規則：通常至個位
- **說明**：銷售額應繳的營業稅
- **範例**：`10`（= 200 × 0.05）、`0`（零稅率）

### 2️⃣7️⃣ totalAmount - 總計
- **長度**：-（decimal）
- **必填**：是
- **計算**：`totalAmount = salesAmount + taxAmount - discountAmount`
- **驗證**：
  - 須與計算值相符
  - 折讓時可為負數
- **說明**：最終應收金額
- **範例**：`210`（= 200 + 10 - 0）、`-210`（折讓）

### 2️⃣8️⃣ discountAmount - 折扣金額
- **長度**：-（decimal）
- **必填**：否
- **說明**：銷售折扣額（通常為正數，代表折扣金額）
- **驗證**：無折扣填 `0`
- **範例**：`0`、`50`

### 2️⃣9️⃣ cardLast4No - 信用卡末四碼
- **長度**：4 碼
- **必填**：否
- **說明**：若使用信用卡支付，記錄卡號末四碼（隱私保護）
- **驗證**：無信用卡交易可空白
- **範例**：`1234`、空白

---

## ✅ 匯入前檢查清單

### 編碼與格式
- [ ] 編碼確認：檔案必須是 UTF-8（無 BOM）
- [ ] 分隔符號：確認使用管線符 `|` 分隔（非逗號或其他）
- [ ] 檔案無 Header：第一列直接是資料（非標題列）
- [ ] 檔名格式：`invoice_[BAN]_[YYYYMMDD]_[4位數].csv`
- [ ] 檔名數字：末 4 碼數字 = 實際資料行數

### 日期時間
- [ ] invoiceDate 格式：yyyyMMdd（8 碼，如 20250113）
- [ ] invoiceTime 格式：HH:mm:ss（8 碼含冒號，如 12:00:01）
- [ ] 日期邏輯：發票日期不超過當日（視系統設定）

### 發票號碼與配號
- [ ] invoiceNumber 格式：[A-Z]{2}[0-9]{8}（如 AB12345678）
- [ ] 發票號在配號範圍：須符合 E0501 配號的起迄號
- [ ] 字軌須與配號檔一致

### 統編與客戶
- [ ] sellerIdentifier：8 碼數字，須對應已建檔客戶
- [ ] buyerIdentifier：若無統編填 `0000000000`
- [ ] buyerName：無統編時填 `0000`

### 發票內容
- [ ] invoiceType：使用 `07` 或 `08`
- [ ] donateMark：`0` 或 `1`
- [ ] printMark：`Y` 或 `N`
- [ ] randomNumber：4 碼 [0-9A] 格式（如 1A2B）

### 載具驗證
- [ ] 若 carrierType=`3J0002`，carrierId1=/ABC1234（含/）
- [ ] 若 carrierType=`CQ0001`，carrierId1=/AB12345678901234（含/）
- [ ] 無載具可全部留空

### 捐贈驗證
- [ ] 若 donateMark=1，npoban 必填（3-7 碼或 8 碼統編）
- [ ] 若 donateMark=0，npoban 可空白

### 金額計算
- [ ] totalAmount = salesAmount × (1 + taxRate) - discountAmount
- [ ] salesAmount + freeTaxSalesAmount + zeroTaxSalesAmount 應合理
- [ ] taxAmount = salesAmount × taxRate（允許小數舍入）
- [ ] amount = quantity × unitPrice

### 多明細聚合
- [ ] 同發票號多列時，invoiceNumber + invoiceDate 應相同
- [ ] 明細金額應加總至 salesAmount/totalAmount
- [ ] sequenceNumber 應依序遞增

### 特殊欄位
- [ ] description：不超過 256 字
- [ ] sellerName/buyerName：不超過 60 字
- [ ] quantity/unitPrice：支援小數點

### 檔案完整性
- [ ] 檔案編碼確認無誤（避免亂碼）
- [ ] 計算 MD5：`md5 filename.csv`（macOS）或 `certutil -hashfile filename.csv MD5`（Windows）
- [ ] 檔案大小合理（避免過大）

---

## ❌ 常見匯入錯誤

### ❌ 發票號碼格式錯誤
**原因**：不符 [A-Z]{2}[0-9]{8} 格式
```
A123          ❌ 太短（只有 4 碼）
AB1234567     ❌ 只有 7 碼數字（應 8 碼）
AB1234567X    ❌ 含非數字字元
ab12345678    ❌ 小寫字母（應大寫）
AB-12345678   ❌ 包含特殊符號
```

### ❌ 載具顯碼格式錯誤
**原因**：3J0002 應為 /[\\dA-Z0-9+-\\.]{7}，CQ0001 應為 /[A-Z]{2}[0-9]{14}
```
# 3J0002 手機條碼
ABC1234       ❌ 缺少 / 符號（應為 /ABC1234）
/ABC1234      ✓ 正確
/AB12         ❌ 太短（應 7 碼）

# CQ0001 自然人憑證
AB12345678901234 ❌ 缺少 / 符號
/AB12345678901234 ✓ 正確
```

### ❌ 隨機碼格式錯誤
**原因**：必須是 [0-9A]{4}，不能含 B-Z 或其他字元
```
1A2B          ✓ 正確
1A2B3         ❌ 5 碼（應 4 碼）
1A2X          ❌ 含 X（應只用 0-9 或 A）
1a2b          ❌ 小寫（應大寫 A）
AAAA          ✓ 正確
0000          ✓ 正確
```

### ❌ 檔名記錄數不符
**原因**：檔名末 4 碼與實際資料列數不一致
```
# 檔名：invoice_12345678_20250113_0005.csv
# 但檔案有 7 行資料 ❌ 應為 0007.csv

# 正確示例
invoice_12345678_20250113_0001.csv    ✓ 1 行資料
invoice_12345678_20250113_0005.csv    ✓ 5 行資料
invoice_12345678_20250113_0050.csv    ✓ 50 行資料
```

### ❌ 編碼錯誤
**原因**：檔案編碼不是 UTF-8 導致亂碼
```
# macOS/Linux 轉換
iconv -f BIG5 -t UTF-8 old.csv > new.csv

# 驗證編碼（macOS）
file -I invoice.csv
# 應顯示：text/plain; charset=utf-8

# 驗證編碼（Linux）
file -i invoice.csv
```

### ❌ 日期格式錯誤
**原因**：不是 yyyyMMdd 或包含其他符號
```
2025-01-13    ❌ 包含 - 符號（應為 20250113）
2025/01/13    ❌ 包含 / 符號（應為 20250113）
25-01-13      ❌ 2 碼年份（應 4 碼）
202501133     ❌ 9 碼（應 8 碼）
20250113      ✓ 正確
```

### ❌ 時間格式錯誤
**原因**：不是 HH:mm:ss 格式
```
12:00:1       ❌ 秒數 1 碼（應 2 碼 01）
120001        ❌ 無冒號分隔
12:00:01 AM   ❌ 包含 AM/PM 標記（應 24h 制）
12:00:01      ✓ 正確
00:00:00      ✓ 正確
23:59:59      ✓ 正確
```

### ❌ 金額計算錯誤
**原因**：totalAmount ≠ salesAmount × (1 + taxRate)
```
# 應稅銷售額 200，稅率 5%
# 正確計算：200 × 1.05 = 210
# 稅額：200 × 0.05 = 10

# 錯誤範例
200|5|0.05|211  ❌ totalAmount 應 210（不是 211）
200|10|0.05|200 ❌ totalAmount 應 210（不是 200）

# 正確範例
200|10|0.05|210 ✓
```

### ❌ 買方統編無效
**原因**：buyerIdentifier 不符規範
```
9876543          ❌ 7 碼（應 8 碼或 10 碼）
0000000000       ✓ 無統編（個人購買）
98765432         ✓ 8 碼統編
1234567890       ✓ 10 碼統編
```

### ❌ 捐贈設定不符
**原因**：donateMark=1 但 npoban 未填或無效
```
# 若 donateMark=1，npoban 必填
donateMark=1, npoban=        ❌ npoban 未填
donateMark=1, npoban=12      ❌ npoban 2 碼（應 3-7 碼）
donateMark=1, npoban=71101   ✓ 正確（5 碼捐贈代號）
donateMark=0, npoban=        ✓ 可空白
```

---

## 🔗 多明細聚合規則

### 同發票多明細原理
當同一張發票的多個商品分行輸入時：

```
相同的發票號碼 + 相同的發票日期
         ↓
     系統聚合為
         ↓
      一張發票
         ↓
    金額自動加總
```

### 輸入格式
**第一行**：包含完整發票資訊 + 第一筆明細
```
C0401|AB00001003|20250102|09:15:00|12345678|匯泓企業社|11111111|B公司|07|0|3J0002|/XYZ5678|0|Y|0|3E4F|商品A|1|500|500|1|1000|0|0|1|0.05|50|1050|0|
```

**後續行**：可簡化為明細資訊 + 對應金額
```
C0401|AB00001003|20250102|09:15:00|12345678|匯泓企業社|11111111|B公司|07|0|3J0002|/XYZ5678|0|Y|0|3E4F|商品B|1|500|500|2|
```

### 金額聚合邏輯
系統會自動加總同發票的金額：

```
商品 A：500 元
商品 B：500 元
────────────
合計：1000 元（自動加總至 salesAmount）
稅額：50 元（自動計算）
總計：1050 元（自動計算）
```

### 實際範例
```
# 第 1 列：詳細資訊（含金額）
C0401|AB00001003|20250102|09:15:00|12345678|匯泓企業社|11111111|B公司|07|0|3J0002|/XYZ5678|0|Y|0|3E4F|商品A|1|500|500|1|1000|0|0|1|0.05|50|1050|0|

# 第 2 列：簡化格式（可省略發票基本資訊）
C0401|AB00001003|20250102|09:15:00|12345678|匯泓企業社|11111111|B公司|07|0|3J0002|/XYZ5678|0|Y|0|3E4F|商品B|1|500|500|2|

# 系統聚合後
發票號碼：AB00001003
發票日期：20250102
商品 1：商品A，1 件，500 元
商品 2：商品B，1 件，500 元
應稅銷售額：1000 元
稅額：50 元
總計：1050 元
```

---

## 📌 特殊欄位說明

### 🎫 PrintMark 已列印標記

| 值 | 說明 | 財政部要求 | 載具需求 |
|---|------|----------|--------|
| Y | 已列印（紙本發票） | 需印出紙本副本 | 無特殊要求 |
| N | 未列印（電子發票） | 以電子方式交付 | 須填載具資訊 |

**驗證規則**：
- 若 printMark=Y，應 printMark=N（通常 N 為現代做法）
- 若 printMark=Y 且載具為空，可能違規

### 🎁 DonateMark 捐贈標記

| 值 | 說明 | npoban 要求 | 範例 |
|---|------|-----------|------|
| 0 | 不捐贈（一般銷售） | 可空白 | 商業交易 |
| 1 | 捐贈（納入發票抽獎） | 必填：3-7 碼或 8 碼統編 | 71101（紅十字會） |

**驗證規則**：
- `donateMark=1` + `npoban=71101` ✓ 正確
- `donateMark=1` + `npoban=空白` ❌ 錯誤
- `donateMark=0` + `npoban=任意` ✓ 可接受

### 🚗 CarrierType 載具類別

| 值 | 說明 | carrierId1 格式 | 使用場景 |
|---|------|----------------|--------|
| 3J0002 | 手機條碼 | /XXXXXXX（7 碼） | 零售/便利店 |
| CQ0001 | 自然人憑證 | /[A-Z]{2}[0-9]{14} | 個人/辦公 |
| 會員載具 | 公司會員代號 | 會員號碼 | 特定企業 |
| 空白 | 無載具 | 空白 | 紙本發票 |

**驗證規則**：
- 3J0002：carrierId1=/ABC1234（含 /）
- CQ0001：carrierId1=/AB12345678901234
- 無載具：都可留空

### 🎲 RandomNumber 防偽隨機碼

**格式**：4 碼 [0-9A] 組合
```
允許組合：0-9 及 A（只有這 11 個字元）
不允許：  B-Z、特殊符號、小寫

有效範例：0000、AAAA、1A2B、9Z9Z ❌ (Z 不允許)
```

**驗證邏輯**：
- 財政部會驗證隨機碼唯一性
- 不可全相同（如 0000 或 AAAA 通常被限制）
- 通常系統會自動產生防重

### 💳 CardLast4No 信用卡末四碼

**隱私保護**：
- 僅記錄末 4 碼（隱藏前 12 碼）
- 不記錄完整卡號
- 用於交易記錄追蹤

**範例**：
```
完整卡號：1234 5678 9012 3456
記錄為：  3456（末 4 碼）
或表示為：****-****-****-3456
```

---

## 🧪 測試步驟

### 步驟 1：準備測試檔案
1. 建立最小化測試 CSV（1-3 筆 C0401 記錄）
2. 選擇合理的期別（對應當前或近期）
3. 確保統編在系統中已建檔
4. 載具資訊（如有）正確填寫

### 步驟 2：驗證檔案格式
```bash
# macOS/Linux 檢查編碼
file -I invoice_test.csv
# 應輸出：text/plain; charset=utf-8

# 檢查分隔符號（應為 |）
head -1 invoice_test.csv | od -c | grep '|'

# 計算 MD5
md5 invoice_test.csv
# 記錄結果供驗證
```

### 步驟 3：通過 API 或 UI 上傳
```
系統路徑：發票管理 → CSV 匯入 → 選擇 Invoice 類型
選擇檔案：invoice_test.csv
填入 MD5：<之前計算的 MD5>
點擊匯入
```

### 步驟 4：查詢匯入日誌
```sql
-- 查詢匯入結果
SELECT * FROM import_file_log 
WHERE upload_file_name LIKE '%invoice_test%'
ORDER BY upload_time DESC;

-- 應看到：
-- upload_status = SUCCESS 或 PROCESSING
-- error_message = NULL（若成功）
```

### 步驟 5：驗證發票資料
```sql
-- 查詢新建發票
SELECT 
  id, uid, invoice_number, invoice_date, 
  seller_identifier, buyer_identifier, 
  sales_amount, tax_amount, total_amount
FROM invoice
WHERE invoice_date >= '2025-01-13'
ORDER BY created_at DESC;

-- 驗證欄位：
-- invoice_number: AB00001002
-- sales_amount: 200
-- tax_amount: 10
-- total_amount: 210
```

### 步驟 6：檢查關聯資料
```sql
-- 驗證發票明細
SELECT id, description, quantity, unit_price, amount, sequence_number
FROM invoice_item
WHERE invoice_id = <上步驟查到的發票 ID>;

-- 驗證輸出結果
-- quantity: 2
-- unit_price: 100
-- amount: 200
```

---

## 📞 問題排查

### Q: 檔案上傳時提示「編碼錯誤」
**A**: 確保 UTF-8 編碼（無 BOM）
```bash
# macOS/Linux 轉換
iconv -f BIG5 -t UTF-8 old.csv > new.csv

# 或使用 Visual Studio Code
# 右下角「UTF-8」→「以其他編碼重新開啟」→ UTF-8
```

### Q: 「發票號碼不在配號範圍內」
**A**: 檢查 E0501 配號檔是否已匯入且有效
```sql
SELECT * FROM invoice_assign_no
WHERE invoice_track = 'AB'
AND invoice_begin_no <= '12345678'
AND invoice_end_no >= '12345678';
```

### Q: 「金額計算不符」
**A**: 重新驗證金額公式
```
totalAmount = salesAmount × (1 + taxRate) - discountAmount
例：200 × 1.05 - 0 = 210
```

### Q: 「買方統編無效」
**A**: 若無統編，統一填 `0000000000`，buyerName 填 `0000`

### Q: 多明細聚合失敗
**A**: 確保 invoiceNumber + invoiceDate 完全相同（包括格式）
```
✓ AB00001003 + 20250102 聚合成一張發票
❌ AB00001003 + 2025-01-02 不聚合（日期格式不同）
```

---

## 📄 相關文件

- `E0501_template.md` - 電子發票配號檔 CSV 匯入範本
- `import-spec.md` - 完整匯入規範與技術說明
- Invoice.java - 發票 Entity 原始碼
- InvoiceAssignNo.java - 配號 Entity 原始碼
