# E0501 營業人電子發票配號檔 - 匯入範本

## 📋 欄位對應（以 InvoiceAssignNo Entity 欄位為基準）

| Index | Entity 欄位名 | 中文說明 | 型態 | 必填 | 長度 | 範例 |
|-------|--------------|--------|------|------|------|------|
| 0 | customer.ban | 公司統編 | string | Y | 8 | 12345678 |
| 1 | invoiceType | 發票類別代號 | string | Y | - | 07/08 |
| 2 | 保留(暫未使用) | 保留欄位 | - | - | - | - |
| 3 | yearMonth | 發票期別 | string | Y | 5 | 11102(表示111/01~111/02) |
| 4 | invoiceTrack | 發票字軌 | string | Y | 2 | AB(2碼大寫英文) |
| 5 | invoiceBeginNo | 發票起號 | string | Y | 8 | 00883662(8碼數字) |
| 6 | invoiceEndNo | 發票迄號 | string | Y | 8 | 00884111(8碼數字) |

---

## 📝 範例資料

### 範例一：標準配號檔（單一組）
```
12345678,7,,11102,AB,00883662,00884111
```

### 範例二：多組配號（分行輸入）
```
12345678,7,,11102,AB,00883662,00884111
12345678,7,,11102,AB,00884112,00884161
12345678,8,,11102,CD,00450000,00450049
```

---

## 📂 檔案格式說明

### 編碼格式
- **推薦編碼**：BIG5（繁體中文 Windows）
- **備選編碼**：UTF-8（跨平台相容，系統自動移除 BOM）
- **系統處理**：兩種編碼均支援，無需手動轉換

### 分隔符號
- **分隔符**：逗號 `,`
- **無引號**：欄位內容無需加引號
- **無 header**：資料直接開始，程式自動移除第一列

### 檔名規範
- **格式**：`e0501_[BAN]_[YYYYMMDD].csv`
- **範例**：
  - `e0501_12345678_20220913.csv`
  - `e0501_24053211_20251101.csv`

### 第一列處理
- **程式行為**：自動移除檔案第一列作為 header
- **建議**：可選擇性地加入描述列以提高可讀性
- **注意**：確保資料列從第二列開始

---

## 🎯 欄位詳細說明

### 0️⃣ 公司統編（Customer.BAN）
- **長度**：8 碼數字
- **必填**：是
- **驗證**：系統驗證統編格式
- **說明**：需對應系統中已建檔的客戶
- **範例**：`12345678`、`24053211`

### 1️⃣ 發票類別代號（InvoiceType）
- **長度**：1-2 碼
- **必填**：是
- **有效值**：
  - `07` = 一般稅額計算發票
  - `08` = 特種稅額計算發票
- **說明**：決定發票計算稅額方式
- **範例**：`07`

### 2️⃣ 保留欄位（InvoiceSourceType）
- **長度**：任意
- **必填**：否
- **說明**：暫未使用，可留空
- **用途**：預留給未來擴展

### 3️⃣ 發票期別（YearMonth）
- **長度**：5 碼
- **必填**：是
- **格式**：`YYMM`（年份後2碼 + 月份，取雙月後2碼）
- **驗證**：
  - 必須為雙月（01, 03, 05, 07, 09, 11）
  - 需對應配號檔申報期間
- **說明**：系統會根據此欄位檢查配號有效期
- **範例**：
  - `11102` = 民國111年1月/2月期間
  - `11104` = 民國111年3月/4月期間
  - `11202` = 民國112年1月/2月期間

### 4️⃣ 發票字軌（InvoiceTrack）
- **長度**：2 碼
- **必填**：是
- **字元限制**：大寫英文字母（A-Z）
- **驗證**：
  - 必須是英文大寫
  - 不可使用小寫或數字
- **說明**：識別不同發票字軌
- **範例**：`AB`、`CD`、`WB`、`XX`

### 5️⃣ 發票起號（InvoiceBeginNo）
- **長度**：8 碼數字
- **必填**：是
- **格式**：8 位數字
- **驗證規則**：
  - 第 7-8 碼（最後兩碼）必須為 `00` 或 `50`
  - 不可為 `01-49` 或 `51-99` 等其他值
  - 原因：配號通常以 50 張為 1 組
- **說明**：本組配號起始號碼
- **範例**：`00883662`（末尾 62 符合規則）、`00884100`（末尾 00）

### 6️⃣ 發票迄號（InvoiceEndNo）
- **長度**：8 碼數字
- **必填**：是
- **格式**：8 位數字
- **驗證規則**：
  - 第 7-8 碼（最後兩碼）必須為 `49` 或 `99`
  - 必須大於等於起號（BeginNo ≤ EndNo）
  - 通常為起號 +50 -1 或 +100 -1
- **說明**：本組配號終止號碼
- **範例**：`00884111`（末尾 11 但應為 49 或 99，此例需驗證）、`00884049`、`00884099`

---

## ✅ 匯入前檢查清單

- [ ] **編碼確認**：檔案為 BIG5 或 UTF-8 格式
- [ ] **分隔符號**：確認使用逗號 `,` 分隔（非管線符或其他符號）
- [ ] **檔名格式**：遵循 `e0501_[BAN]_[YYYYMMDD].csv` 格式
- [ ] **第一列**：可加入 header 說明，程式自動移除
- [ ] **統編驗證**：確認統編對應系統中客戶
- [ ] **發票類別**：使用 `07` 或 `08`
- [ ] **期別驗證**：期別為雙月（01/03/05/07/09/11）
- [ ] **字軌驗證**：2 碼大寫英文字母
- [ ] **起號驗證**：8 碼數字，末尾為 `00` 或 `50`
- [ ] **迄號驗證**：8 碼數字，末尾為 `49` 或 `99`，應 ≥ 起號
- [ ] **號碼連續性**：檢查配號是否重複或有空隙
- [ ] **50 張分組**：確認起-迄號間距合理（通常 50 或 100 張為 1 組）
- [ ] **日期合理性**：發票期別與上傳日期邏輯相符

---

## ❌ 常見匯入錯誤

### ❌ 統編格式錯誤
**原因**：不是 8 位純數字
```
12345   ❌ 太短（7碼）
123456789 ❌ 太長（9碼）
123ABC78 ❌ 包含非數字
```

### ❌ 發票類別無效
**原因**：使用了無效的發票類別代號
```
1       ❌ 應使用 07 或 08
7       ❌ 應使用 07
09      ❌ 無此類別
```

### ❌ 期別格式錯誤
**原因**：期別不符 YYMM 格式或非雙月
```
202209    ❌ 4 碼年份（應為 2 碼）
1102      ❌ 4 碼（應為 5 碼，含民國年 YY+月 MM）
11103     ❌ 非雙月（應為 01/03/05 等）
```

### ❌ 字軌格式錯誤
**原因**：字軌包含非英文或使用小寫
```
ab        ❌ 小寫（應為大寫 AB）
a1        ❌ 包含數字（應為純英文）
A         ❌ 只有 1 碼（應為 2 碼）
ABC       ❌ 3 碼（應為 2 碼）
```

### ❌ 起號末尾不符規則
**原因**：最後兩碼既不是 00 也不是 50
```
00883651  ❌ 末尾 51（應為 00 或 50）
00883662  ⚠️  末尾 62（通常不符合規則，需確認）
00883700  ✓  末尾 00（正確）
00883750  ✓  末尾 50（正確）
```

### ❌ 迄號末尾不符規則
**原因**：最後兩碼既不是 49 也不是 99
```
00884050  ❌ 末尾 50（應為 49 或 99）
00884111  ❌ 末尾 11（應為 49 或 99）
00884049  ✓  末尾 49（正確）
00884099  ✓  末尾 99（正確）
```

### ❌ 起迄號倒序
**原因**：起號 > 迄號
```
00884111,00883662 ❌ 迄號小於起號（應為起號 ≤ 迄號）
00883662,00883661 ❌ 迄號小於起號
```

---

## 🔗 關聯說明

### InvoiceAssignNo Entity 與 E0501 的關係

| InvoiceAssignNo 欄位 | 來源 | 說明 |
|------------------|------|------|
| `id` | 自動生成 | 主鍵，系統自動分配 |
| `uid` | 自動生成 | UUID，系統自動產生，供 Gateway 與 Client 同步用 |
| `invoiceSourceType` | 自動判定 | 通常設為 INVOICE_ASSIGN_NO（E0501 來源） |
| `invoiceType` | E0501 欄位 1 | 發票類別（07/08） |
| `yearMonth` | E0501 欄位 3 | 發票期別（5 碼）|
| `invoiceTrack` | E0501 欄位 4 | 字軌（2 碼英文） |
| `invoiceBeginNo` | E0501 欄位 5 | 起號（8 碼數字） |
| `invoiceEndNo` | E0501 欄位 6 | 迄號（8 碼數字） |
| `invoiceBooklet` | 自動計算 | 組數 = (迄號 - 起號) / 50 + 1 |
| `customer` | E0501 欄位 0 | 以統編關聯到 Customer entity |

### 發票配號流程

```
E0501 CSV 匯入
    ↓
逐行解析欄位 0-6
    ↓
驗證發票類別、期別、字軌、起迄號格式
    ↓
根據統編查詢對應 Customer
    ↓
計算 invoiceBooklet（50 張為 1 組）
    ↓
建立 InvoiceAssignNo entity
    ↓
寫入資料庫 INVOICE_ASSIGN_NO 表
    ↓
生成 Turnkey XML 配號檔
    ↓
對應 Gateway 的配號資訊同步
```

---

## 🧪 測試步驟

### 準備測試檔案
1. 建立最小化測試 CSV：1-3 筆配號記錄
2. 選擇合理的期別（對應當前或近期）
3. 確保統編在系統中已建檔

### 範例測試檔案（test_e0501.csv）
```
# Header（會被移除）
公司統編,發票類別,保留,期別,字軌,起號,迄號
12345678,07,,11102,AB,00883650,00883699
12345678,07,,11102,CD,00884000,00884049
24053211,08,,11102,EF,00450000,00450049
```

### 執行測試
1. 確認檔案編碼（BIG5 或 UTF-8）
2. 計算 MD5 值：`md5 test_e0501.csv`（macOS）
3. 通過 API 或 UI 上傳檔案
4. 查詢 `IMPORT_FILE_LOG` 確認匯入狀態
5. 驗證 `INVOICE_ASSIGN_NO` 表中的資料：
   ```sql
   SELECT * FROM invoice_assign_no 
   WHERE customer_id = (SELECT id FROM customer WHERE ban = '12345678')
   ORDER BY year_month, invoice_track;
   ```

### 驗收項目
- [ ] 檔案上傳成功
- [ ] IMPORT_FILE_LOG 顯示 SUCCESS
- [ ] INVOICE_ASSIGN_NO 表中有新增記錄
- [ ] 發票字軌、起迄號、期別正確
- [ ] invoiceBooklet 計算正確（如 50 張應為 1，100 張應為 2）
- [ ] 與 Turnkey XML 配號一致

---

## 📌 備註

### 舊格式對應參考
如果您之前使用舊格式的配號檔，欄位位置對應如下：

| 舊系統欄位 | 新 CSV 索引 | Entity 欄位 |
|----------|-----------|-----------|
| 公司統編 | 0 | customer.ban |
| 發票類別 | 1 | invoiceType |
| 公司名稱 | 2（已移除） | ↓ 自 Customer 讀取 |
| 期別 | 3 | yearMonth |
| 字軌 | 4 | invoiceTrack |
| 起號 | 5 | invoiceBeginNo |
| 迄號 | 6 | invoiceEndNo |

### 遷移建議
1. 從舊系統匯出配號檔
2. 重新整理為新格式（保留欄位 0, 1, 3, 4, 5, 6；移除公司名稱）
3. 確認統編已在新系統中建檔
4. 使用本範本進行匯入

---

## 📞 問題排查

### 常見問題 Q&A

**Q: 檔案上傳時提示「編碼錯誤」**
A: 嘗試使用 UTF-8 編碼。macOS/Linux 用 `iconv -f BIG5 -t UTF-8 old.csv > new.csv` 轉換。

**Q: 迄號末尾應該是 49 還是 99？**
A: 通常取決於配號組成：
- 末尾 49：表示 50 張為 1 組（起號末尾 00，迄號末尾 49）
- 末尾 99：表示 100 張為 1 組（起號末尾 00，迄號末尾 99）

**Q: 系統說「配號已使用」**
A: 檢查是否有重複的起迄號。若需重新配號，請聯繫系統管理員清理舊記錄。

**Q: 能否跨期別配號？**
A: 不建議。每個期別應有獨立的配號字軌與號碼段。

---

## 📄 相關文件

- `Invoice_template.md` - 發票資料(C0401) CSV 匯入範本
- `import-spec.md` - 完整匯入規範與技術說明
- InvoiceAssignNo.java - 配號 Entity 原始碼
