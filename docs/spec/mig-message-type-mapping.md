# MIG 訊息格式整併對應表

## 訊息類型更新追蹤

| 舊訊息類型 | 新訊息類型 | 說明 | 使用場景 |
|-----------|-----------|------|---------|
| A0401 | F0401 | 交換開立發票 → 平台存證開立發票 | 廠商在本系統開立之發票，由平台代為存證 |
| C0401 | F0401 | 直接交換開立發票 → 平台存證開立發票 | 廠商直接上傳之發票，由平台代為存證 |
| A0501 | F0501 | 交換作廢發票 → 平台存證作廢發票 | 廠商在本系統作廢之發票 |
| C0501 | F0501 | 直接交換作廢發票 → 平台存證作廢發票 | 廠商直接上傳之作廢發票 |
| A0601 | 刪除 | 交換退回發票 | MIG 4.0 起不再支援 |
| C0701 | F0701 | 直接交換註銷發票 → 平台存證註銷發票 | 廠商直接上傳之註銷發票 |
| B0401 | G0401 | 交換開立折讓 → 平台存證開立折讓 | 廠商在本系統開立之折讓單 |
| D0401 | G0401 | 直接交換開立折讓 → 平台存證開立折讓 | 廠商直接上傳之折讓單 |
| B0501 | G0501 | 交換作廢折讓 → 平台存證作廢折讓 | 廠商在本系統作廢之折讓單 |
| D0501 | G0501 | 直接交換作廢折讓 → 平台存證作廢折讓 | 廠商直接上傳之作廢折讓單 |

## 系統設計建議

### 1. 資料轉換策略
- **廃棄舊訊息類型**：系統不再產生 A0401、C0401、A0501、C0501、A0601、C0701、B0401、D0401、B0501、D0501
- **統一使用新訊息類型**：轉換邏輯應改為產生 F0401、F0501、F0701、G0401、G0501

### 2. 欄位適配
- **F0401/G0401 欄位擴充**：
  - 新增 ZeroTaxRateReason（零稅率原因）
  - 新增 Reserved1、Reserved2（保留欄位）
  - CarrierId1、CarrierId2 由 64 位擴展至 400 位
  - 明細 ProductItem 由 999 項擴展至 9999 項
  - 明細欄位長度大幅擴展（Description: 256→500、Remark: 40→120 等）

### 3. 新增欄位處理（MIG 4.1）
- **OriginalInvoiceSellerId/OriginalInvoiceBuyerId**：用於賣方/買方統編變更或合併消滅時追溯原始發票資訊
- **AllowanceType**：折讓單必填，固定值 2（配合統一發票使用辦法第 20 條之 1）

### 4. 資料驗證
- 金額欄位（SalesAmount、TaxAmount、TotalAmount 等）不應為負數，XML Schema 應加入 minInclusive="0" 限制
- BAN（統編）改為限制數字字元

## MIG 4.0 → MIG 4.1 遞進
- MIG 4.0：主要進行訊息整併、欄位擴展
- MIG 4.1：依新法規調整送方規則、金額驗證、新增追蹤欄位

## 實施要點
1. **優先支援 MIG 4.1**：建議直接採用 MIG 4.1 規範，毋需支援 MIG 4.0
2. **向下相容**：若需相容舊廠商系統，應實作轉換層將舊訊息類型轉為新訊息類型
3. **測試覆蓋**：確保轉換邏輯正確、XML Schema 驗證無誤
